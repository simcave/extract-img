#==========================================================================
# Extract IMG (OpenWrt/Armbian/Other)
# All errors fixed, supports .img.gz & .img.xz
#==========================================================================

name: Extract img file

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      type_file:
        description: "Select type file"
        required: true
        default: "img.xz"
        type: choice
        options:
          - img.xz
          - img.gz
      img_url:
        description: "Set the URL of the IMG file"
        required: true
      rename:
        description: "Name prefix for boot & rootfs"
        required: true

env:
  TZ: Asia/Jakarta

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:

    - name: Checkout Repo
      uses: actions/checkout@main

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get -qq update
        sudo apt-get -y install wget python3
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean

        sudo pip3 install gdown

        # Rust + mediafire_rs
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        export PATH="$HOME/.cargo/bin:$PATH"
        cargo install mediafire_rs

        # Mega CMD
        megacmd_ver=$(sudo cat /etc/*ease | grep "DISTRIB_RELEASE" | awk -F "=" '{print $2}')
        wget https://mega.nz/linux/repo/xUbuntu_${megacmd_ver}/amd64/megacmd-xUbuntu_${megacmd_ver}_amd64.deb
        sudo apt install "./megacmd-xUbuntu_${megacmd_ver}_amd64.deb"

        sudo timedatectl set-timezone "$TZ"

    - name: Download Image File
      run: |
        url="${{ inputs.img_url }}"

        if echo "$url" | grep -q "drive."; then
          # Google Drive
          if [ "$(echo $url | awk -F '/' '{print $6}')" ]; then
            file_id=$(echo $url | awk -F '/' '{print $6}')
          else
            file_id=$(echo $url | awk -F "id=" '{print $2}' | awk -F "&" '{print $1}')
          fi
          gdown "$file_id" -O file.${{ inputs.type_file }}

        elif echo "$url" | grep -q "mediafire.com"; then
          # MediaFire
          mdrs "$url"
          mv *.${{ inputs.type_file }} file.${{ inputs.type_file }}

        elif echo "$url" | grep -q "mega.nz"; then
          # Mega.nz
          file_mega=$(mega-get "$url" | awk -F ":" '{print $2}')
          mv "$file_mega" file.${{ inputs.type_file }}

        else
          # Direct download
          wget --no-check-certificate "$url" -O file.${{ inputs.type_file }}
        fi

    - name: Extract Firmware
      id: extract
      run: |
        mkdir -p boot rootfs img

        echo ">>> Extracting image..."

        if [ "${{ inputs.type_file }}" = "img.gz" ]; then
          # Ignore trailing garbage warning from GoogleDrive/Mega images
          gunzip -f file.img.gz || true

        elif [ "${{ inputs.type_file }}" = "img.xz" ]; then
          unxz -f file.img.xz
        fi

        # Normalize result: always ensure file.img exists
        if [ ! -f file.img ]; then
          mv file.* file.img
        fi

        echo ">>> Attaching loop device..."

        los=$(sudo losetup -fP --show file.img)

        echo ">>> Mounting partitions..."
        sudo mount ${los}p1 boot
        sudo mount ${los}p2 rootfs

        echo ">>> Packing boot..."
        (cd boot && sudo tar cfz ../img/${{ inputs.rename }}-boot.tar.gz *)

        echo ">>> Packing rootfs..."
        (cd rootfs && sudo tar cfz ../img/${{ inputs.rename }}-rootfs.tar.gz *)

        echo "PACKAGED_OUTPUTPATH=./img/*" >> $GITHUB_ENV
        echo "PACKAGED_OUTPUTDATE=$(date +"%m.%d.%H%M")" >> $GITHUB_ENV
        echo "PACKAGED_STATUS=success" >> $GITHUB_ENV

    - name: Upload boot.tar.gz
      uses: actions/upload-artifact@main
      if: env.PACKAGED_STATUS == 'success'
      with:
        name: ${{ inputs.rename }}-boot.tar.gz
        path: ./img/${{ inputs.rename }}-boot.tar.gz

    - name: Upload rootfs.tar.gz
      uses: actions/upload-artifact@main
      if: env.PACKAGED_STATUS == 'success'
      with:
        name: ${{ inputs.rename }}-rootfs.tar.gz
        path: ./img/${{ inputs.rename }}-rootfs.tar.gz

    - name: Upload Release Assets
      uses: svenstaro/upload-release-action@v2
      if: env.PACKAGED_STATUS == 'success'
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ${{ env.PACKAGED_OUTPUTPATH }}
        tag: ${{ env.PACKAGED_OUTPUTDATE }}
        file_glob: true
        overwrite: true
        body: |
          boot & rootfs build

    - name: Check Disk Usage
      run: df -hT

    - name: Cleanup Workflow Logs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3
